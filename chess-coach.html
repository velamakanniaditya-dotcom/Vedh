<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chess Coach ‚ôö ‚Äî Learn with King Leo!</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#f59e0b; --purple:#7c3aed; --green:#22c55e;
  --red:#ef4444; --blue:#38bdf8; --dark:#1c1917;
  --paper:#ffffff; --grid:#e2e8f0;
  --light-sq:#f0d9b5; --dark-sq:#b58863;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Nunito',sans-serif;
  background-color:#1c1917;
  background-image:linear-gradient(rgba(245,158,11,.07) 1px,transparent 1px),
    linear-gradient(90deg,rgba(245,158,11,.07) 1px,transparent 1px);
  background-size:40px 40px;
  min-height:100vh; display:flex; flex-direction:column; align-items:center;
  padding:14px 12px 50px; color:#1c1917;
}
.home-btn{
  position:fixed;top:14px;left:14px;background:#1c1917;
  border:3px solid var(--gold);color:var(--gold);
  padding:7px 14px;border-radius:50px;text-decoration:none;
  font-family:'Fredoka One',cursive;font-size:.95rem;z-index:300;
  box-shadow:0 4px 0 #92400e;
}
.home-btn:active{transform:translateY(4px);box-shadow:none;}
header{text-align:center;margin-top:46px;margin-bottom:12px;}
header h1{font-family:'Fredoka One',cursive;font-size:clamp(1.9rem,6vw,3rem);color:var(--gold);line-height:1;text-shadow:3px 3px 0 rgba(0,0,0,.5);}
header p{font-size:.95rem;font-weight:800;color:#a8a29e;margin-top:4px;}

/* DIFFICULTY SCREEN */
.screen{display:none;width:100%;max-width:700px;animation:popIn .35s cubic-bezier(.175,.885,.32,1.275);}
.screen.active{display:block;}
@keyframes popIn{0%{opacity:0;transform:scale(.92) translateY(14px)}100%{opacity:1;transform:scale(1) translateY(0)}}
.card{background:var(--paper);border:4px solid var(--dark);border-radius:22px;padding:22px 20px;box-shadow:0 8px 0 rgba(0,0,0,.4);margin-bottom:12px;}
.card-title{font-family:'Fredoka One',cursive;font-size:1.5rem;color:var(--dark);text-align:center;margin-bottom:16px;}
.diff-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.diff-btn{
  background:#f8fafc;border:4px solid var(--dark);border-radius:18px;
  padding:18px 10px;text-align:center;cursor:pointer;
  box-shadow:0 6px 0 var(--dark);transition:all .1s;
}
.diff-btn:active{transform:translateY(6px);box-shadow:0 0 0 var(--dark);}
.diff-btn .di{font-size:2.8rem;display:block;margin-bottom:6px;}
.diff-btn .dn{font-family:'Fredoka One',cursive;font-size:1.05rem;color:var(--dark);}
.diff-btn .dd{font-size:.75rem;color:#64748b;font-weight:800;margin-top:3px;}

/* GAME LAYOUT */
.game-layout{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:start;}
@media(max-width:620px){.game-layout{grid-template-columns:1fr;}}

/* BOARD */
.board-col{}
.board-labels{display:flex;padding-left:18px;}
.board-labels span{width:52px;text-align:center;font-family:'Fredoka One',cursive;font-size:.6rem;color:#a8a29e;}
.rank-labels{display:flex;flex-direction:column;}
.rank-labels span{height:52px;width:16px;display:flex;align-items:center;justify-content:flex-end;font-family:'Fredoka One',cursive;font-size:.6rem;color:#a8a29e;padding-right:2px;}
.board-row-wrap{display:flex;}
.chessboard{display:grid;grid-template-columns:repeat(8,52px);border:4px solid var(--dark);border-radius:7px;overflow:hidden;box-shadow:0 8px 0 rgba(0,0,0,.35);}
.sq{
  width:52px;height:52px;display:flex;align-items:center;justify-content:center;
  font-size:1.75rem;cursor:pointer;position:relative;user-select:none;
  transition:filter .1s;
}
.sq.light{background:var(--light-sq);}
.sq.dark{background:var(--dark-sq);}
.sq.sel{background:#f6f669!important;}
/* Move dot safety colors */
.sq.mv-safe::after{content:'';position:absolute;width:36%;height:36%;border-radius:50%;background:rgba(34,197,94,.75);pointer-events:none;z-index:2;}
.sq.mv-risky::after{content:'';position:absolute;width:36%;height:36%;border-radius:50%;background:rgba(245,158,11,.8);pointer-events:none;z-index:2;}
.sq.mv-bad::after{content:'';position:absolute;width:36%;height:36%;border-radius:50%;background:rgba(239,68,68,.8);pointer-events:none;z-index:2;}
.sq.cap-safe::after{content:'';position:absolute;inset:2px;border-radius:50%;border:4px solid rgba(34,197,94,.9);pointer-events:none;z-index:2;}
.sq.cap-risky::after{content:'';position:absolute;inset:2px;border-radius:50%;border:4px solid rgba(245,158,11,.9);pointer-events:none;z-index:2;}
.sq.cap-bad::after{content:'';position:absolute;inset:2px;border-radius:50%;border:4px solid rgba(239,68,68,.9);pointer-events:none;z-index:2;}
/* Threat glow on child's pieces under attack */
.sq.threatened{animation:threatPulse 1.1s ease-in-out infinite;}
@keyframes threatPulse{0%,100%{box-shadow:inset 0 0 0 3px rgba(239,68,68,.0);}50%{box-shadow:inset 0 0 0 3px rgba(239,68,68,.9),inset 0 0 12px rgba(239,68,68,.4);}}
/* Last move highlight */
.sq.lastmove{background:rgba(99,102,241,.35)!important;}
.sq:hover:not(.sel){filter:brightness(1.07);}
@media(max-width:500px){
  .sq{width:42px;height:42px;font-size:1.35rem;}
  .chessboard{grid-template-columns:repeat(8,42px);}
  .board-labels span{width:42px;}
  .rank-labels span{height:42px;}
}

/* RIGHT PANEL */
.panel-col{display:flex;flex-direction:column;gap:10px;}

/* LEO COACH BOX */
.coach-box{
  background:#fef3c7;border:4px solid var(--gold);border-radius:18px;
  padding:14px 16px;box-shadow:0 6px 0 #b45309;position:relative;
}
.coach-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.leo-face{font-size:2.4rem;animation:leoBob 2s ease-in-out infinite;}
@keyframes leoBob{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
.leo-face.talking{animation:leoTalk .25s ease-in-out infinite;}
@keyframes leoTalk{0%,100%{transform:scale(1) translateY(0);}50%{transform:scale(1.18) translateY(-3px);}}
.sound-btn{
  font-family:'Fredoka One',cursive;font-size:.78rem;
  padding:4px 10px;border:2px solid #b45309;border-radius:20px;
  background:rgba(245,158,11,.15);color:#78350f;cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.sound-btn:hover{background:rgba(245,158,11,.3);}
.sound-btn.muted{background:rgba(100,116,139,.15);border-color:#94a3b8;color:#64748b;}
/* Typing cursor animation on Leo's text */
.coach-msg.speaking::after{content:'‚ñå';animation:blink .6s step-end infinite;color:var(--gold);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.coach-name{font-family:'Fredoka One',cursive;font-size:.9rem;color:#78350f;}
.coach-msg{font-size:.88rem;font-weight:800;color:#44403c;line-height:1.6;min-height:44px;}
.coach-tag{display:inline-block;font-size:.65rem;font-weight:900;padding:2px 8px;border-radius:20px;text-transform:uppercase;margin-top:5px;}
.tag-plan {background:#dbeafe;color:#1e40af;border:2px solid #3b82f6;}
.tag-warn {background:#fee2e2;color:#991b1b;border:2px solid #ef4444;}
.tag-good {background:#dcfce7;color:#166534;border:2px solid #22c55e;}
.tag-tip  {background:#f3e8ff;color:#6b21a8;border:2px solid #a855f7;}
.tag-opp  {background:#fff7ed;color:#9a3412;border:2px solid #f97316;}

/* HINT & CONTROLS */
.btn{font-family:'Fredoka One',cursive;font-size:1rem;padding:11px 16px;border-radius:13px;cursor:pointer;border:3px solid var(--dark);box-shadow:0 5px 0 var(--dark);transition:all .1s;display:inline-block;text-align:center;}
.btn:active{transform:translateY(5px);box-shadow:0 0 0 var(--dark);}
.btn-full{width:100%;}
.btn-sm{font-size:.82rem;padding:7px 12px;border-radius:10px;box-shadow:0 4px 0 var(--dark);}
.btn-sm:active{transform:translateY(4px);box-shadow:0 0 0 var(--dark);}
.btn-gold  {background:var(--gold);color:#fff;border-color:#b45309;box-shadow:0 5px 0 #b45309;}
.btn-gold:active{box-shadow:0 0 0 #b45309;}
.btn-green {background:var(--green);color:#fff;border-color:#15803d;box-shadow:0 5px 0 #15803d;}
.btn-green:active{box-shadow:0 0 0 #15803d;}
.btn-purple{background:var(--purple);color:#fff;border-color:#4c1d95;box-shadow:0 5px 0 #4c1d95;}
.btn-purple:active{box-shadow:0 0 0 #4c1d95;}
.btn-red   {background:var(--red);color:#fff;border-color:#b91c1c;box-shadow:0 5px 0 #b91c1c;}
.btn-red:active{box-shadow:0 0 0 #b91c1c;}
.btn-row{display:flex;gap:7px;flex-wrap:wrap;}

/* INFO CARDS */
.info-card{background:#f8fafc;border:3px solid var(--dark);border-radius:14px;padding:12px 14px;box-shadow:0 4px 0 var(--dark);}
.info-card h3{font-family:'Fredoka One',cursive;font-size:.95rem;color:var(--dark);margin-bottom:6px;}
.info-card p{font-size:.8rem;color:#475569;font-weight:700;line-height:1.55;}

/* SCORE / STATUS */
.status-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;}
.score-chip{text-align:center;background:#f8fafc;border:2px solid var(--dark);border-radius:10px;padding:6px 10px;min-width:58px;box-shadow:0 3px 0 var(--dark);}
.score-chip .sl{font-size:.65rem;font-weight:900;color:#64748b;text-transform:uppercase;}
.score-chip .sv{font-family:'Fredoka One',cursive;font-size:1.2rem;color:var(--dark);}
.turn-indicator{font-family:'Fredoka One',cursive;font-size:1rem;padding:8px 14px;border-radius:12px;border:3px solid var(--dark);background:#f8fafc;box-shadow:0 4px 0 var(--dark);}

/* LEGEND */
.legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.leg-item{display:flex;align-items:center;gap:4px;font-size:.7rem;font-weight:800;color:#475569;}
.leg-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0;}

/* MOVE LOG */
.move-log{background:#1e293b;border-radius:10px;padding:8px 10px;font-size:.72rem;color:#7dd3fc;font-weight:700;min-height:26px;font-family:monospace;line-height:1.8;max-height:70px;overflow-y:auto;word-break:break-all;}

/* LEVEL PICKER IN-GAME */
.level-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.level-btn{font-family:'Fredoka One',cursive;font-size:.75rem;padding:5px 10px;border:2px solid var(--dark);border-radius:20px;background:#f8fafc;cursor:pointer;box-shadow:0 3px 0 var(--dark);transition:all .1s;}
.level-btn:active{transform:translateY(3px);box-shadow:none;}
.level-btn.active{background:var(--purple);color:#fff;border-color:#4c1d95;}

/* CAPTURED PIECES */
.cap-row{font-size:1rem;min-height:22px;color:#475569;font-weight:700;}

/* PREVIEW OVERLAY */
.preview-banner{
  background:#1e40af;color:#fff;border:3px solid #1e40af;border-radius:12px;
  padding:8px 12px;font-weight:800;font-size:.82rem;text-align:center;display:none;
}
.preview-banner.show{display:block;animation:popIn .3s;}

/* CONFETTI */
.confetti-wrap{position:fixed;inset:0;pointer-events:none;z-index:999;}
.cp{position:absolute;border-radius:2px;animation:cpFall 1.8s ease-in forwards;}
@keyframes cpFall{0%{transform:translateY(-40px) rotate(0);opacity:1}100%{transform:translateY(105vh) rotate(720deg);opacity:0}}

/* RESULT OVERLAY */
.result-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;
  display:none;align-items:center;justify-content:center;
}
.result-overlay.show{display:flex;}
.result-box{
  background:var(--paper);border:5px solid var(--dark);border-radius:24px;
  padding:32px 28px;text-align:center;box-shadow:0 12px 0 rgba(0,0,0,.5);
  max-width:340px;width:90%;animation:popIn .4s ease;
}
.result-box .re{font-size:3.5rem;margin-bottom:8px;}
.result-box h2{font-family:'Fredoka One',cursive;font-size:1.8rem;color:var(--dark);margin-bottom:8px;}
.result-box p{font-size:.9rem;font-weight:800;color:#475569;margin-bottom:18px;}
</style>
</head>
<body>
<a href="index.html" class="home-btn">üè† Home</a>
<a href="chess.html" style="position:fixed;top:16px;right:16px;background:#1c1917;border:3px solid #7c3aed;color:#a78bfa;padding:7px 14px;border-radius:50px;text-decoration:none;font-family:'Fredoka One',cursive;font-size:.9rem;z-index:300;box-shadow:0 4px 0 #4c1d95;">üìñ Learn Chess</a>
<header>
  <h1>‚ôö Chess Coach</h1>
  <p>Learn to think ahead with King Leo! ü¶Å</p>
</header>

<!-- DIFFICULTY SCREEN -->
<div class="screen active" id="diffScreen">
  <div class="card">
    <div class="card-title">Choose your opponent!</div>
    <div class="diff-grid">
      <div class="diff-btn" onclick="startGame('easy')">
        <span class="di">üê£</span>
        <div class="dn">Tiny Tim</div>
        <div class="dd">Makes mistakes ‚Äî perfect for beginners!</div>
      </div>
      <div class="diff-btn" onclick="startGame('medium')">
        <span class="di">ü¶Å</span>
        <div class="dn">Captain Leo</div>
        <div class="dd">Plays fair ‚Äî a real challenge!</div>
      </div>
      <div class="diff-btn" onclick="startGame('hard')">
        <span class="di">üßô</span>
        <div class="dn">Wizard Max</div>
        <div class="dd">Very tough ‚Äî are you ready?</div>
      </div>
    </div>
    <div class="info-card" style="margin-top:14px;">
      <h3>üéì What makes this special?</h3>
      <p>üü¢ Green dots = safe moves &nbsp;üü° Yellow = risky &nbsp;üî¥ Red = danger!<br>
      üî¥ Red glow = your piece is under attack!<br>
      üí¨ Leo explains every computer move!<br>
      üí° Ask Leo for hints anytime!</p>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="gameScreen" style="max-width:720px;">
  <!-- Status bar -->
  <div class="card" style="padding:12px 16px;margin-bottom:10px;">
    <div class="status-row">
      <div class="turn-indicator" id="turnIndicator">‚¨ú Your Turn!</div>
      <div style="display:flex;gap:7px;">
        <div class="score-chip"><div class="sl">You</div><div class="sv" id="yourScore">0</div></div>
        <div class="score-chip"><div class="sl">Leo</div><div class="sv" id="leoScore">0</div></div>
      </div>
      <div class="level-row">
        <button class="level-btn" id="lb-easy"   onclick="changeDiff('easy')">üê£</button>
        <button class="level-btn" id="lb-medium"  onclick="changeDiff('medium')">ü¶Å</button>
        <button class="level-btn" id="lb-hard"   onclick="changeDiff('hard')">üßô</button>
        <button class="btn btn-sm btn-red" onclick="newGame()">‚Ü∫ New</button>
      </div>
    </div>
    <div class="cap-row" id="capRow" style="margin-top:6px;"></div>
  </div>

  <div class="game-layout">
    <!-- BOARD -->
    <div class="board-col">
      <div class="board-labels" id="colLabels">
        <span>a</span><span>b</span><span>c</span><span>d</span><span>e</span><span>f</span><span>g</span><span>h</span>
      </div>
      <div class="board-row-wrap">
        <div class="rank-labels" id="rankLabels"></div>
        <div class="chessboard" id="chessboard"></div>
      </div>
      <div class="legend" style="margin-top:6px;">
        <div class="leg-item"><div class="leg-dot" style="background:#22c55e;"></div>Safe move</div>
        <div class="leg-item"><div class="leg-dot" style="background:#f59e0b;"></div>Risky</div>
        <div class="leg-item"><div class="leg-dot" style="background:#ef4444;"></div>Danger!</div>
        <div class="leg-item" style="margin-left:4px;">üî¥ glow = your piece attacked</div>
      </div>
    </div>

    <!-- PANEL -->
    <div class="panel-col">
      <!-- Leo Coach -->
      <div class="coach-box">
        <div class="coach-header">
          <span class="leo-face" id="leoFace">ü¶Å</span>
          <div style="flex:1;">
            <div class="coach-name" id="leoName">King Leo says:</div>
            <span class="coach-tag tag-tip" id="leoTag">TIP</span>
          </div>
          <button class="sound-btn" id="soundBtn" onclick="toggleSound()" title="Toggle Leo's voice">üîä Voice ON</button>
        </div>
        <div class="coach-msg" id="leoMsg">Welcome! I'm Leo ‚Äî your chess coach! Pick a piece and I'll show you which moves are safe. Green = go, Yellow = careful, Red = trap!</div>
      </div>

      <!-- Buttons -->
      <div class="btn-row">
        <button class="btn btn-gold btn-full" onclick="getHint()" id="hintBtn">üí° Give me a hint!</button>
      </div>
      <div class="btn-row">
        <button class="btn btn-sm btn-purple" onclick="togglePreview()" id="previewBtn">üëÅ Think Ahead</button>
        <button class="btn btn-sm btn-green" onclick="explainPosition()">üìñ What's the plan?</button>
      </div>

      <!-- Preview banner -->
      <div class="preview-banner" id="previewBanner">üëÅ THINK AHEAD MODE ‚Äî Click a piece to preview the position after moving!</div>

      <!-- Threat warning -->
      <div id="threatBox" style="display:none;">
        <div class="info-card" style="border-color:var(--red);background:#fff5f5;">
          <h3 style="color:#991b1b;">‚ö†Ô∏è Watch out!</h3>
          <p id="threatMsg" style="color:#7f1d1d;"></p>
        </div>
      </div>

      <!-- Move log -->
      <div class="info-card">
        <h3>üìù Move History</h3>
        <div class="move-log" id="moveLog">Game not started yet‚Ä¶</div>
      </div>

      <!-- Captured -->
      <div class="info-card">
        <h3>‚öñÔ∏è Captured pieces</h3>
        <div style="font-size:.82rem;font-weight:700;color:#475569;margin-bottom:3px;">You captured:</div>
        <div id="youCap" style="font-size:1.1rem;min-height:20px;">‚Äî</div>
        <div style="font-size:.82rem;font-weight:700;color:#475569;margin:5px 0 3px;">Leo captured:</div>
        <div id="leoCap" style="font-size:1.1rem;min-height:20px;">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- RESULT OVERLAY -->
<div class="result-overlay" id="resultOverlay">
  <div class="result-box">
    <div class="re" id="resEmoji">üéâ</div>
    <h2 id="resTitle">You Win!</h2>
    <p id="resMsg">Amazing thinking!</p>
    <button class="btn btn-gold btn-full" onclick="newGame()" style="margin-bottom:10px;">Play Again! üéÆ</button>
    <button class="btn btn-sm" onclick="document.getElementById('resultOverlay').classList.remove('show');document.getElementById('diffScreen').classList.add('active');document.getElementById('gameScreen').classList.remove('active');" style="background:#e2e8f0;border-color:#94a3b8;box-shadow:0 4px 0 #94a3b8;color:#334155;width:100%;">Change Difficulty</button>
  </div>
</div>
<div class="confetti-wrap" id="confettiWrap"></div>
<script>
'use strict';

/* ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê */
const WP=['‚ôî','‚ôï','‚ôñ','‚ôó','‚ôò','‚ôô'];
const BP=['‚ôö','‚ôõ','‚ôú','‚ôù','‚ôû','‚ôü'];
const isW=p=>WP.includes(p), isB=p=>BP.includes(p);
const PVAL={'‚ôô':1,'‚ôü':1,'‚ôò':3,'‚ôû':3,'‚ôó':3,'‚ôù':3,'‚ôñ':5,'‚ôú':5,'‚ôï':9,'‚ôõ':9,'‚ôî':100,'‚ôö':100};
const PNAME={'‚ôô':'Pawn','‚ôü':'Pawn','‚ôò':'Knight','‚ôû':'Knight','‚ôó':'Bishop','‚ôù':'Bishop','‚ôñ':'Rook','‚ôú':'Rook','‚ôï':'Queen','‚ôõ':'Queen','‚ôî':'King','‚ôö':'King'};
const FILES=['a','b','c','d','e','f','g','h'];
const RANKS=['8','7','6','5','4','3','2','1'];
const SQ=(r,c)=>FILES[c]+RANKS[r];

const START=[
  ['‚ôú','‚ôû','‚ôù','‚ôõ','‚ôö','‚ôù','‚ôû','‚ôú'],
  ['‚ôü','‚ôü','‚ôü','‚ôü','‚ôü','‚ôü','‚ôü','‚ôü'],
  ['','','','','','','',''],['','','','','','','',''],
  ['','','','','','','',''],['','','','','','','',''],
  ['‚ôô','‚ôô','‚ôô','‚ôô','‚ôô','‚ôô','‚ôô','‚ôô'],
  ['‚ôñ','‚ôò','‚ôó','‚ôï','‚ôî','‚ôó','‚ôò','‚ôñ']
];

/* ‚ïê‚ïê‚ïê GAME STATE ‚ïê‚ïê‚ïê */
let board=[], sel=null, turn='w', diff='medium';
let moveLog=[], youCap=[], leoCap=[], leoThinking=false;
let previewMode=false, previewPiece=null;
let yourScore=0, leoScore=0;
let lastFrom=null, lastTo=null;
let hintSquare=null;

/* ‚ïê‚ïê‚ïê MOVE GENERATOR ‚ïê‚ïê‚ïê */
function getMoves(b,r,c,forCheck=false){
  const p=b[r][c]; if(!p) return [];
  const moves=[];
  const friendly=isW(p)?isW:isB;
  const add=(nr,nc)=>{
    if(nr<0||nr>7||nc<0||nc>7) return;
    if(friendly(b[nr][nc])) return;
    moves.push([nr,nc]);
  };
  const slide=(dr,dc)=>{
    let nr=r+dr,nc=c+dc;
    while(nr>=0&&nr<8&&nc>=0&&nc<8){
      if(friendly(b[nr][nc])) break;
      moves.push([nr,nc]); if(b[nr][nc]) break;
      nr+=dr; nc+=dc;
    }
  };
  switch(p){
    case'‚ôô':
      if(r>0&&!b[r-1][c]){moves.push([r-1,c]);if(r===6&&!b[r-2][c])moves.push([r-2,c]);}
      if(r>0&&c>0&&isB(b[r-1][c-1]))moves.push([r-1,c-1]);
      if(r>0&&c<7&&isB(b[r-1][c+1]))moves.push([r-1,c+1]); break;
    case'‚ôü':
      if(r<7&&!b[r+1][c]){moves.push([r+1,c]);if(r===1&&!b[r+2][c])moves.push([r+2,c]);}
      if(r<7&&c>0&&isW(b[r+1][c-1]))moves.push([r+1,c-1]);
      if(r<7&&c<7&&isW(b[r+1][c+1]))moves.push([r+1,c+1]); break;
    case'‚ôò':case'‚ôû':[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]].forEach(([dr,dc])=>add(r+dr,c+dc));break;
    case'‚ôó':case'‚ôù':[[-1,-1],[-1,1],[1,-1],[1,1]].forEach(d=>slide(...d));break;
    case'‚ôñ':case'‚ôú':[[-1,0],[1,0],[0,-1],[0,1]].forEach(d=>slide(...d));break;
    case'‚ôï':case'‚ôõ':[[-1,-1],[-1,1],[1,-1],[1,1],[-1,0],[1,0],[0,-1],[0,1]].forEach(d=>slide(...d));break;
    case'‚ôî':case'‚ôö':[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]].forEach(([dr,dc])=>add(r+dr,c+dc));break;
  }
  return moves;
}

/* squares attacked by a side */
function attackedSquares(b, byWhite){
  const set=new Set();
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=b[r][c];
    if(!p) continue;
    if(byWhite&&!isW(p)) continue;
    if(!byWhite&&!isB(p)) continue;
    getMoves(b,r,c).forEach(([mr,mc])=>set.add(mr*8+mc));
  }
  return set;
}

/* is a square safe for White to move to? */
function safetyOf(b,fr,fc,tr,tc){
  // simulate move
  const nb=b.map(row=>[...row]);
  const moved=nb[fr][fc];
  const victim=nb[tr][tc];
  nb[tr][tc]=moved; nb[fr][fc]='';
  // is the piece on (tr,tc) now attacked by black?
  const attacked=attackedSquares(nb,false);
  if(!attacked.has(tr*8+tc)) return 'safe'; // not attacked at all
  // it IS attacked ‚Äî can we take back?
  if(victim) {
    // we captured ‚Äî attacker must take our piece
    const vVal=PVAL[victim]||0, mVal=PVAL[moved]||0;
    if(vVal>mVal) return 'safe'; // won material, worth it even if recaptured
    if(vVal===mVal) return 'risky';
    return 'bad';
  }
  return 'risky'; // moving to attacked empty square
}

/* find king position */
function kingPos(b,white){
  const k=white?'‚ôî':'‚ôö';
  for(let r=0;r<8;r++) for(let c=0;c<8;c++) if(b[r][c]===k) return [r,c];
  return null;
}

/* is king in check? */
function inCheck(b,white){
  const pos=kingPos(b,white); if(!pos) return false;
  const opp=attackedSquares(b,!white);
  return opp.has(pos[0]*8+pos[1]);
}

/* all legal moves for a side */
function allLegal(b,white){
  const moves=[];
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=b[r][c];
    if(!p||(white?!isW(p):!isB(p))) continue;
    getMoves(b,r,c).forEach(([tr,tc])=>{
      const nb=b.map(row=>[...row]);
      nb[tr][tc]=nb[r][c]; nb[r][c]='';
      if(!inCheck(nb,white)) moves.push({fr:r,fc:c,tr,tc});
    });
  }
  return moves;
}

/* ‚ïê‚ïê‚ïê EVALUATION ‚ïê‚ïê‚ïê */
const CENTER_BONUS=[[0,0,0,0,0,0,0,0],[0,1,1,1,1,1,1,0],[0,1,2,3,3,2,1,0],[0,1,3,4,4,3,1,0],[0,1,3,4,4,3,1,0],[0,1,2,3,3,2,1,0],[0,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0]];
function evaluate(b){
  let score=0;
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const p=b[r][c]; if(!p) continue;
    const v=(PVAL[p]||0)*100;
    const cb=CENTER_BONUS[r][c];
    if(isW(p)) score-=v+cb;
    else score+=v+cb;
  }
  return score;
}

/* ‚ïê‚ïê‚ïê MINIMAX AI ‚ïê‚ïê‚ïê */
function minimax(b,depth,alpha,beta,maxing){
  if(depth===0) return evaluate(b);
  const legal=allLegal(b,maxing);
  if(legal.length===0) return maxing ? -10000 : 10000;
  if(maxing){
    let best=-Infinity;
    for(const m of legal){
      const nb=b.map(r=>[...r]); nb[m.tr][m.tc]=nb[m.fr][m.fc]; nb[m.fr][m.fc]='';
      if(nb[m.tr][m.tc]==='‚ôü'&&m.tr===7) nb[m.tr][m.tc]='‚ôõ';
      const val=minimax(nb,depth-1,alpha,beta,false);
      best=Math.max(best,val); alpha=Math.max(alpha,val);
      if(beta<=alpha) break;
    }
    return best;
  } else {
    let best=Infinity;
    for(const m of legal){
      const nb=b.map(r=>[...r]); nb[m.tr][m.tc]=nb[m.fr][m.fc]; nb[m.fr][m.fc]='';
      if(nb[m.tr][m.tc]==='‚ôô'&&m.tr===0) nb[m.tr][m.tc]='‚ôï';
      const val=minimax(nb,depth-1,alpha,beta,true);
      best=Math.min(best,val); beta=Math.min(beta,val);
      if(beta<=alpha) break;
    }
    return best;
  }
}

function getBestMove(b,difficulty){
  const legal=allLegal(b,false);
  if(legal.length===0) return null;
  // Easy: random 40% of the time
  if(difficulty==='easy'&&Math.random()<0.4) return legal[Math.floor(Math.random()*legal.length)];
  const depth=difficulty==='easy'?1:difficulty==='medium'?2:3;
  let best=null, bestVal=-Infinity;
  for(const m of legal){
    const nb=b.map(r=>[...r]); nb[m.tr][m.tc]=nb[m.fr][m.fc]; nb[m.fr][m.fc]='';
    if(nb[m.tr][m.tc]==='‚ôü'&&m.tr===7) nb[m.tr][m.tc]='‚ôõ';
    const val=minimax(nb,depth-1,-Infinity,Infinity,true);
    if(val>bestVal){bestVal=val;best=m;}
  }
  return best;
}

/* ‚ïê‚ïê‚ïê MOVE EXPLANATION GENERATOR ‚ïê‚ïê‚ïê */
function explainLeoMove(fr,fc,tr,tc,captured,b){
  const p=b[tr][tc];
  const pn=PNAME[p]||'piece';
  const from=SQ(fr,fc), to=SQ(tr,tc);
  const msgs=[];

  // Capturing move
  if(captured){
    const cn=PNAME[captured];
    const cv=PVAL[captured]||0, pv=PVAL[p]||0;
    if(cv>pv) msgs.push(`I took your ${cn} with my ${pn}! I gained ${cv} points for free! üéâ`);
    else if(cv===pv) msgs.push(`I traded my ${pn} for your ${cn} ‚Äî a fair swap! That's fine with me.`);
    else msgs.push(`I took your ${cn}! Even though it cost me a bit, it helps my plan. üòà`);
  }
  // Castling
  else if((p==='‚ôö')&&Math.abs(tc-fc)===2){
    msgs.push("I'm castling my King to safety! Smart move ‚Äî my King is much safer behind those pawns now! üè∞");
  }
  // Check
  else if(inCheck(b,true)){
    msgs.push(`Check! My ${pn} moved to ${to} and now your King is in danger! You MUST protect your King first! ‚ö†Ô∏è`);
  }
  // Development
  else if((fr===0||fr===1)&&(p==='‚ôû'||p==='‚ôù')){
    msgs.push(`I'm developing my ${pn} ‚Äî getting it into the game from ${from} to ${to}. Pieces in the middle control more squares! üß†`);
  }
  // Center control
  else if(tr>=3&&tr<=4&&tc>=3&&tc<=4){
    msgs.push(`I moved my ${pn} to ${to} ‚Äî right in the CENTER! Center pieces are the most powerful. I'm trying to control the board! üéØ`);
  }
  // Pawn advance
  else if(p==='‚ôü'){
    msgs.push(`I pushed my pawn to ${to}. Pawns help me control space and they can become a Queen if they reach your side! ‚ôü`);
  }
  // Generic
  else {
    const plans=[
      `I moved my ${pn} to ${to} to get a better position. Can you see what I'm planning? ü§î`,
      `My ${pn} is now on ${to}. I'm setting up a plan ‚Äî watch out! Think about what I might do next! üëÄ`,
      `${pn} to ${to}! I'm trying to control more squares. Look at all the squares my piece now attacks! üß©`,
    ];
    msgs.push(plans[Math.floor(Math.random()*plans.length)]);
  }
  return msgs[0];
}

/* ‚ïê‚ïê‚ïê THREAT DETECTION ‚ïê‚ïê‚ïê */
function findThreats(){
  const threats=[];
  const blackAttacked=attackedSquares(board,false);
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    if(isW(board[r][c])&&blackAttacked.has(r*8+c)){
      threats.push({r,c,piece:board[r][c]});
    }
  }
  return threats;
}

function showThreats(){
  const threats=findThreats();
  const box=document.getElementById('threatBox');
  const msg=document.getElementById('threatMsg');
  if(threats.length===0){
    box.style.display='none'; return;
  }
  box.style.display='block';
  const names=threats.map(t=>`${PNAME[t.piece]} on ${SQ(t.r,t.c)}`);
  if(threats.length===1){
    msg.textContent=`Your ${names[0]} is under attack! Move it to safety or protect it! üõ°Ô∏è`;
  } else {
    msg.textContent=`Watch out! Your ${names.join(' and your ')} are all in danger! Protect them! üõ°Ô∏è`;
  }
}

/* ‚ïê‚ïê‚ïê HINT SYSTEM ‚ïê‚ïê‚ïê */
function getHint(){
  if(turn!=='w'||leoThinking) return;
  const legal=allLegal(board,true);
  if(legal.length===0) return;
  // score each move
  let best=null, bestVal=-Infinity;
  for(const m of legal){
    const nb=board.map(r=>[...r]); nb[m.tr][m.tc]=nb[m.fr][m.fc]; nb[m.fr][m.fc]='';
    if(nb[m.tr][m.tc]==='‚ôô'&&m.tr===0) nb[m.tr][m.tc]='‚ôï';
    const val=minimax(nb,1,-Infinity,Infinity,false)*-1;
    if(val>bestVal){bestVal=val;best=m;}
  }
  if(!best) return;
  hintSquare=[best.fr,best.fc];
  renderBoard();
  // Explain the hint
  const p=board[best.fr][best.fc];
  const pn=PNAME[p];
  const captured=board[best.tr][best.tc];
  let msg='';
  if(captured){
    msg=`üí° Hint: Move your ${pn} from ${SQ(best.fr,best.fc)} to ${SQ(best.tr,best.tc)} ‚Äî capture the ${PNAME[captured]} for ${PVAL[captured]} points! Always grab free material!`;
  } else if(inCheck(board,true)){
    msg=`üí° Hint: Your King is in check! Move your ${pn} from ${SQ(best.fr,best.fc)} to ${SQ(best.tr,best.tc)} to escape danger!`;
  } else {
    const saf=safetyOf(board,best.fr,best.fc,best.tr,best.tc);
    const safMsg=saf==='safe'?'It\'s completely safe there!':saf==='risky'?'It\'s a bit risky but worth it!':'Be careful ‚Äî it\'s advanced!';
    msg=`üí° Hint: Try moving your ${pn} from ${SQ(best.fr,best.fc)} to ${SQ(best.tr,best.tc)}. ${safMsg}`;
  }
  leoSay(msg,'tip');
  // Highlight the hint piece for 3s
  setTimeout(()=>{ hintSquare=null; renderBoard(); }, 3500);
}

/* ‚ïê‚ïê‚ïê POSITION EXPLAINER ‚ïê‚ïê‚ïê */
function explainPosition(){
  const threats=findThreats();
  const legal=allLegal(board,true);
  const checks=inCheck(board,true);
  let msg='';
  if(checks){
    msg='‚ö†Ô∏è Your King is in CHECK right now! You MUST get out of check ‚Äî either move the King, block the attack, or capture the attacker!';
  } else if(threats.length>0){
    const pn=PNAME[threats[0].piece];
    msg=`üõ°Ô∏è Your ${pn} is under attack! You could move it to safety, block the attack, or counter-attack something even bigger! Always think: "Is my plan worth what I might lose?"`;
  } else if(legal.length<5){
    msg=`üò¨ You don't have many moves! Be careful ‚Äî if you run out of moves but you're NOT in check, that's STALEMATE and the game is a draw! Make sure your pieces have room to breathe!`;
  } else {
    const phase=moveLog.length<10?'opening':moveLog.length<30?'middle':'endgame';
    const plans={
      opening:`üìñ Opening phase! Your goals right now: 1) Move pawns to control the center (e4, d4), 2) Develop your knights and bishops, 3) Castle to keep your King safe!`,
      middle:`üß† Middle game! Your pieces are out ‚Äî now make a PLAN! Look for pieces you can capture, weak spots in Leo's camp, and ways to attack the King!`,
      endgame:`üèÅ Endgame! Fewer pieces on the board ‚Äî your King becomes a fighter! Push your passed pawns toward promotion and use your King actively!`
    };
    msg=plans[phase];
  }
  leoSay(msg,'plan');
}

/* ‚ïê‚ïê‚ïê RENDER BOARD ‚ïê‚ïê‚ïê */
function renderBoard(){
  const cb=document.getElementById('chessboard'); if(!cb) return;
  const blackAttacked=attackedSquares(board,false);
  const hintR=hintSquare?hintSquare[0]:null, hintC=hintSquare?hintSquare[1]:null;

  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const sq=document.getElementById(`sq_${r}_${c}`); if(!sq) continue;
    let cls='sq '+((r+c)%2===0?'light':'dark');
    // last move highlight
    if(lastFrom&&lastFrom[0]===r&&lastFrom[1]===c) cls+=' lastmove';
    if(lastTo&&lastTo[0]===r&&lastTo[1]===c) cls+=' lastmove';
    // hint highlight
    if(hintR===r&&hintC===c) cls+=' sel';
    // selected
    if(sel&&sel[0]===r&&sel[1]===c) cls+=' sel';
    sq.className=cls;
    sq.textContent=board[r][c]||'';
    // threat glow on white pieces
    if(isW(board[r][c])&&blackAttacked.has(r*8+c)) sq.classList.add('threatened');
  }

  // show valid moves if piece selected
  if(sel&&!previewMode){
    const [sr,sc]=sel;
    getMoves(board,sr,sc).forEach(([mr,mc])=>{
      const nb=board.map(ro=>[...ro]); nb[mr][mc]=nb[sr][sc]; nb[sr][sc]='';
      if(inCheck(nb,true)) return; // illegal, skip
      const sq=document.getElementById(`sq_${mr}_${mc}`);
      const saf=safetyOf(board,sr,sc,mr,mc);
      const capture=!!board[mr][mc];
      if(capture) sq.classList.add('cap-'+saf);
      else        sq.classList.add('mv-'+saf);
    });
  }
  showThreats();
  updateCapDisplay();
}

function buildBoard(){
  const cb=document.getElementById('chessboard'); cb.innerHTML='';
  const rl=document.getElementById('rankLabels'); rl.innerHTML='';
  for(let r=0;r<8;r++){
    const s=document.createElement('span'); s.textContent=RANKS[r]; rl.appendChild(s);
    for(let c=0;c<8;c++){
      const sq=document.createElement('div');
      sq.id=`sq_${r}_${c}`; sq.className='sq '+((r+c)%2===0?'light':'dark');
      sq.onclick=()=>handleClick(r,c); cb.appendChild(sq);
    }
  }
  renderBoard();
}

/* ‚ïê‚ïê‚ïê PLAYER CLICK ‚ïê‚ïê‚ïê */
function handleClick(r,c){
  if(turn!=='w'||leoThinking) return;

  // Preview mode
  if(previewMode){
    handlePreviewClick(r,c); return;
  }

  const piece=board[r][c];
  if(sel){
    const [sr,sc]=sel;
    const valid=getMoves(board,sr,sc).filter(([mr,mc])=>{
      const nb=board.map(ro=>[...ro]); nb[mr][mc]=nb[sr][sc]; nb[sr][sc]='';
      return !inCheck(nb,true);
    });
    if(valid.some(([vr,vc])=>vr===r&&vc===c)){
      doPlayerMove(sr,sc,r,c);
    } else if(isW(piece)){
      sel=[r,c]; renderBoard();
      coachOnSelect(r,c);
    } else { sel=null; renderBoard(); }
  } else if(isW(piece)){
    sel=[r,c]; renderBoard();
    coachOnSelect(r,c);
  }
}

/* coach commentary when player selects a piece */
function coachOnSelect(r,c){
  const p=board[r][c], pn=PNAME[p];
  const moves=getMoves(board,r,c).filter(([mr,mc])=>{
    const nb=board.map(ro=>[...ro]); nb[mr][mc]=nb[r][c]; nb[r][c]='';
    return !inCheck(nb,true);
  });
  const captures=moves.filter(([mr,mc])=>isB(board[mr][mc]));
  const safe=moves.filter(([mr,mc])=>safetyOf(board,r,c,mr,mc)==='safe');
  if(captures.length>0){
    const cap=board[captures[0][0]][captures[0][1]];
    leoSay(`Your ${pn} can capture the ${PNAME[cap]}! üéØ Green ring = safe capture, Yellow = you'll be taken back, Red = bad trade!`,'good');
  } else if(safe.length===0&&moves.length>0){
    leoSay(`Your ${pn} has no truly safe moves! üò¨ All squares are Yellow or Red ‚Äî that means any move is a bit risky. Think carefully!`,'warn');
  } else {
    leoSay(`Good pick! Your ${pn} on ${SQ(r,c)} is selected. Green dots = safe, Yellow = risky, Red = don't go there! Where do you want to move?`,'tip');
  }
}

/* ‚ïê‚ïê‚ïê PLAYER MOVE ‚ïê‚ïê‚ïê */
function doPlayerMove(fr,fc,tr,tc){
  const captured=board[tr][tc];
  if(captured) youCap.push(captured);
  board[tr][tc]=board[fr][fc]; board[fr][fc]='';
  // Promotion
  if(board[tr][tc]==='‚ôô'&&tr===0){
    board[tr][tc]='‚ôï';
    leoSay("üåü PROMOTION! Your pawn reached the end and became a Queen! That's one of the most exciting moments in chess!",'good');
  }
  lastFrom=[fr,fc]; lastTo=[tr,tc]; sel=null; hintSquare=null;
  const notation=`You: ${board[tr][tc]}${SQ(tr,tc)}${captured?'x'+PNAME[captured]:''}`;
  moveLog.push(notation);
  updateMoveLog();
  renderBoard();

  // Post-move coach feedback
  let fb='';
  if(captured){
    const cv=PVAL[captured]||0, mv=PVAL[board[tr][tc]]||0;
    if(cv>mv) fb=`üí∞ Great capture! You won ${cv-mv} points of material! That's winning!`;
    else if(cv===mv) fb=`‚ÜîÔ∏è Fair trade ‚Äî you swapped equal pieces. That's fine!`;
    else fb=`Hmm ‚Äî you gave away more than you got. Always check: is the trade worth it? ü§î`;
  }
  // Check if player's move put Leo in check
  if(inCheck(board,false)) fb=`‚ö° CHECK! Your move put Leo's King in danger! Leo MUST deal with the check now!`;

  // Warn if any of player's pieces are now threatened
  const threats=findThreats();
  if(threats.length>0&&!fb){
    const pn=PNAME[threats[0].piece];
    fb=`‚ö†Ô∏è After your move, your ${pn} on ${SQ(threats[0].r,threats[0].c)} is now under attack! Did you see that coming?`;
  }
  if(fb) leoSay(fb, captured?(PVAL[captured]>PVAL[board[tr][tc]]?'good':'warn'):'warn');

  // Check game over
  if(checkGameOver()) return;
  // Leo's turn
  turn='b'; updateTurnIndicator();
  setTimeout(()=>leoMove(),700);
}

/* ‚ïê‚ïê‚ïê LEO MOVE ‚ïê‚ïê‚ïê */
function leoMove(){
  leoThinking=true;
  leoSay("Hmm... let me think... ü§î",'tip');
  document.getElementById('leoFace').textContent='ü§î';
  setTimeout(()=>{
    const m=getBestMove(board,diff);
    if(!m){ leoThinking=false; checkGameOver(); return; }
    const captured=board[m.tr][m.tc];
    if(captured) leoCap.push(captured);
    const prev=board[m.fr][m.fc];
    board[m.tr][m.tc]=board[m.fr][m.fc]; board[m.fr][m.fc]='';
    if(board[m.tr][m.tc]==='‚ôü'&&m.tr===7) board[m.tr][m.tc]='‚ôõ';
    lastFrom=[m.fr,m.fc]; lastTo=[m.tr,m.tc];
    const notation=`Leo: ${board[m.tr][m.tc]}${SQ(m.tr,m.tc)}${captured?'x'+PNAME[captured]:''}`;
    moveLog.push(notation);
    updateMoveLog();
    renderBoard();
    const explanation=explainLeoMove(m.fr,m.fc,m.tr,m.tc,captured,board);
    const tag=inCheck(board,true)?'warn':captured?'opp':'plan';
    document.getElementById('leoFace').textContent=getDiffFace();
    leoSay(explanation, tag);
    leoThinking=false;
    if(checkGameOver()) return;
    turn='w'; updateTurnIndicator();
    // Immediate threat warning after Leo moves
    setTimeout(()=>{
      const th=findThreats();
      if(th.length>0&&!inCheck(board,true)){
        const pn=PNAME[th[0].piece];
        leoSay(`üëÄ Look carefully! Your ${pn} on ${SQ(th[0].r,th[0].c)} can now be taken by me! Should you move it?`,'warn');
      }
    }, 1800);
  }, 600);
}

/* ‚ïê‚ïê‚ïê PREVIEW MODE ‚ïê‚ïê‚ïê */
function togglePreview(){
  previewMode=!previewMode;
  const btn=document.getElementById('previewBtn');
  const banner=document.getElementById('previewBanner');
  if(previewMode){
    btn.textContent='‚ùå Exit Think Ahead';
    btn.style.background='var(--red)'; btn.style.borderColor='#b91c1c'; btn.style.color='#fff';
    banner.classList.add('show');
    leoSay("üëÅ Think Ahead mode ON! Click any of YOUR pieces to see what the board would look like after you move. No moves are actually made!",'tip');
    sel=null; renderBoard();
  } else {
    btn.textContent='üëÅ Think Ahead'; btn.style.background=''; btn.style.borderColor=''; btn.style.color='';
    banner.classList.remove('show');
    previewPiece=null; sel=null; renderBoard();
    leoSay("Think Ahead mode OFF. Make your real move now!",'tip');
  }
}

function handlePreviewClick(r,c){
  if(!previewPiece){
    if(isW(board[r][c])){ previewPiece=[r,c]; sel=[r,c]; renderBoard(); leoSay(`Showing moves for ${PNAME[board[r][c]]} on ${SQ(r,c)}. Click a move destination to PREVIEW that position!`,'tip'); }
    return;
  }
  const [pr,pc]=previewPiece;
  const valid=getMoves(board,pr,pc).filter(([mr,mc])=>{
    const nb=board.map(ro=>[...ro]); nb[mr][mc]=nb[pr][pc]; nb[pr][pc]='';
    return !inCheck(nb,true);
  });
  if(valid.some(([vr,vc])=>vr===r&&vc===c)){
    // show preview
    const nb=board.map(ro=>[...ro]);
    const cap=nb[r][c];
    nb[r][c]=nb[pr][pc]; nb[pr][pc]='';
    showPreviewPosition(nb,pr,pc,r,c,cap);
  } else if(isW(board[r][c])){
    previewPiece=[r,c]; sel=[r,c]; renderBoard();
  } else { previewPiece=null; sel=null; renderBoard(); }
}

function showPreviewPosition(nb,fr,fc,tr,tc,captured){
  // Temporarily render preview board
  const cb=document.getElementById('chessboard');
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    const sq=document.getElementById(`sq_${r}_${c}`); if(!sq) continue;
    sq.className='sq '+((r+c)%2===0?'light':'dark');
    if(r===tr&&c===tc) sq.classList.add('sel');
    sq.textContent=nb[r][c]||'';
  }
  const saf=safetyOf(board,fr,fc,tr,tc);
  let preview=`üëÅ PREVIEW: If you move ${PNAME[board[fr][fc]]} to ${SQ(tr,tc)}‚Ä¶ `;
  if(captured) preview+=`You capture ${PNAME[captured]}! `;
  if(inCheck(nb,false)) preview+=`That puts Leo's King in CHECK! `;
  const threats=[];
  const ba=attackedSquares(nb,false);
  for(let r=0;r<8;r++) for(let c=0;c<8;c++) if(isW(nb[r][c])&&ba.has(r*8+c)) threats.push(PNAME[nb[r][c]]);
  if(threats.length>0) preview+=`But your ${threats[0]} would be under attack after! `;
  preview+=saf==='safe'?'‚úÖ Looks safe!':saf==='risky'?'‚ö†Ô∏è A bit risky!':'üö® Dangerous move!';
  leoSay(preview,'plan');
  setTimeout(()=>{ previewPiece=null; sel=null; renderBoard(); },3000);
}

/* ‚ïê‚ïê‚ïê GAME OVER CHECK ‚ïê‚ïê‚ïê */
function checkGameOver(){
  const wLegal=allLegal(board,true);
  const bLegal=allLegal(board,false);
  if(wLegal.length===0){
    if(inCheck(board,true)){
      leoScore++;
      showResult('üòî','Checkmate ‚Äî Leo wins!','Don\'t worry! Chess takes practice. You played great and learned a lot! Play again and beat Leo next time! ü¶Å');
    } else {
      showResult('ü§ù','Stalemate ‚Äî It\'s a Draw!','A stalemate! You ran out of moves but weren\'t in check. In real chess this is a draw ‚Äî clever trick sometimes!');
    }
    return true;
  }
  if(bLegal.length===0){
    if(inCheck(board,false)){
      yourScore++;
      confetti();
      showResult('üéâ','YOU WIN! Checkmate!','AMAZING! You checkmated Leo! You thought ahead, saw the plan, and executed it perfectly! You\'re a chess champion! üëë');
    } else {
      showResult('ü§ù','Stalemate ‚Äî It\'s a Draw!','Leo ran out of moves ‚Äî that\'s a stalemate! You were so strong that Leo had no options. Nearly a win!');
    }
    return true;
  }
  return false;
}

// Speak welcome when page loads
window.addEventListener('load', ()=>{
  initSpeech();
  setTimeout(()=>{
    leoSpeak("Welcome to Chess Coach! I am Leo, your chess teacher! Choose how hard you want to play, then I will help you every step of the way!");
  }, 800);
});
let soundOn=true, speechReady=false, preferredVoice=null, speakQueue=[];

// Strip emojis and symbols so speech sounds natural
function cleanForSpeech(txt){
  return txt
    .replace(/[ü¶Åüê£üßô‚ôö‚ôõ‚ôú‚ôù‚ôû‚ôü‚ôî‚ôï‚ôñ‚ôó‚ôò‚ôôüéâüòîü§ùüîäüí°üëÅüìñ‚ö†Ô∏è‚úÖüè∞üåüüòàüéØüí•üç¥üìåüîÑüí´üéÆüß†üõ°Ô∏èüìù‚öñÔ∏è‚ùåüî¥üü¢üü°üö®]/gu,'')
    .replace(/[^\x00-\x7F]/g,'')   // remove remaining non-ASCII
    .replace(/\s+/g,' ')
    .replace(/[‚ÜîÔ∏è‚Üí‚Üê‚Üë‚Üì‚Üó‚Üò‚Üô‚Üñ]/g,'')
    .trim();
}

// Pick the best available voice for kids
function pickVoice(){
  const voices=window.speechSynthesis.getVoices();
  if(!voices.length) return null;
  // Preference order: friendly named voices first
  const preferred=['Google UK English Female','Samantha','Karen','Moira','Fiona','Google US English','Microsoft Zira','Microsoft Hazel'];
  for(const name of preferred){
    const v=voices.find(v=>v.name.includes(name.split(' ')[0])&&(name.split(' ').length<3||v.name.includes(name.split(' ')[1])));
    if(v) return v;
  }
  // Fall back: prefer English female
  const engFem=voices.find(v=>v.lang.startsWith('en')&&v.name.toLowerCase().includes('fem'));
  if(engFem) return engFem;
  // Fall back: any English
  const eng=voices.find(v=>v.lang.startsWith('en'));
  return eng||voices[0]||null;
}

function initSpeech(){
  if(!('speechSynthesis' in window)) return;
  const load=()=>{ preferredVoice=pickVoice(); speechReady=true; };
  if(window.speechSynthesis.getVoices().length) load();
  window.speechSynthesis.onvoiceschanged=load;
}

// Voice personality per character
function getVoiceSettings(){
  if(diff==='easy')   return {rate:0.78, pitch:1.35};  // Tiny Tim: slow, high, cute
  if(diff==='hard')   return {rate:0.88, pitch:0.92};  // Wizard Max: slightly deeper, mysterious
  return               {rate:0.82, pitch:1.15};         // Captain Leo: warm, clear, friendly
}

function leoSpeak(text){
  if(!soundOn||!speechReady||!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const clean=cleanForSpeech(text);
  if(!clean) return;
  const utt=new SpeechSynthesisUtterance(clean);
  const {rate,pitch}=getVoiceSettings();
  utt.rate=rate; utt.pitch=pitch; utt.volume=1;
  if(preferredVoice) utt.voice=preferredVoice;
  // Animate Leo's face while talking
  const face=document.getElementById('leoFace');
  const msgEl=document.getElementById('leoMsg');
  utt.onstart=()=>{ face.classList.add('talking'); msgEl.classList.add('speaking'); };
  utt.onend=utt.onerror=()=>{ face.classList.remove('talking'); msgEl.classList.remove('speaking'); };
  window.speechSynthesis.speak(utt);
}

function toggleSound(){
  soundOn=!soundOn;
  const btn=document.getElementById('soundBtn');
  if(soundOn){
    btn.textContent='üîä Voice ON'; btn.classList.remove('muted');
    leoSpeak('Voice is on! I can talk to you now!');
  } else {
    window.speechSynthesis?.cancel();
    document.getElementById('leoFace').classList.remove('talking');
    document.getElementById('leoMsg').classList.remove('speaking');
    btn.textContent='üîá Voice OFF'; btn.classList.add('muted');
  }
}

/* ‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê */
function leoSay(msg, tag='tip'){
  // Strip emoji prefixes for display cleanliness but keep content
  document.getElementById('leoMsg').textContent=msg;
  const tags={tip:'TIP üí°',warn:'‚ö†Ô∏è DANGER',good:'‚úÖ NICE!',plan:'üìñ PLAN',opp:'üéÆ LEO SAYS'};
  const cls={tip:'tag-tip',warn:'tag-warn',good:'tag-good',plan:'tag-plan',opp:'tag-opp'};
  const t=document.getElementById('leoTag');
  t.textContent=tags[tag]||tags.tip; t.className='coach-tag '+(cls[tag]||cls.tip);
  // Speak it!
  leoSpeak(msg);
}
function updateTurnIndicator(){
  const el=document.getElementById('turnIndicator');
  el.textContent=turn==='w'?'‚¨ú Your Turn!':'‚¨õ Leo thinking‚Ä¶';
  el.style.background=turn==='w'?'#fef3c7':'#f1f5f9';
  el.style.borderColor=turn==='w'?'var(--gold)':'#94a3b8';
}
function updateMoveLog(){
  const ml=document.getElementById('moveLog');
  ml.textContent=moveLog.slice(-8).join('  |  ');
  ml.scrollTop=ml.scrollHeight;
}
function updateCapDisplay(){
  document.getElementById('youCap').textContent=youCap.length?youCap.join(''):'‚Äî';
  document.getElementById('leoCap').textContent=leoCap.length?leoCap.join(''):'‚Äî';
  document.getElementById('yourScore').textContent=yourScore;
  document.getElementById('leoScore').textContent=leoScore;
}
function getDiffFace(){return diff==='easy'?'üê£':diff==='medium'?'ü¶Å':'üßô';}
function showResult(emoji,title,msg){
  document.getElementById('resEmoji').textContent=emoji;
  document.getElementById('resTitle').textContent=title;
  document.getElementById('resMsg').textContent=msg;
  document.getElementById('resultOverlay').classList.add('show');
  // Speak the result with extra enthusiasm
  setTimeout(()=>leoSpeak(title+'. '+msg), 400);
}
function confetti(){
  const w=document.getElementById('confettiWrap'); w.innerHTML='';
  const colors=['#f59e0b','#7c3aed','#22c55e','#ef4444','#38bdf8'];
  for(let i=0;i<60;i++){
    const cp=document.createElement('div'); cp.className='cp';
    cp.style.cssText=`left:${Math.random()*100}%;width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;background:${colors[i%5]};animation-delay:${Math.random()*1.2}s;animation-duration:${1.4+Math.random()*.8}s;`;
    w.appendChild(cp);
  }
  setTimeout(()=>w.innerHTML='',3500);
}

/* ‚ïê‚ïê‚ïê GAME INIT ‚ïê‚ïê‚ïê */
function startGame(d){
  diff=d;
  initSpeech();
  document.getElementById('diffScreen').classList.remove('active');
  document.getElementById('gameScreen').classList.add('active');
  document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('lb-'+d).classList.add('active');
  document.getElementById('leoFace').textContent=getDiffFace();
  document.getElementById('leoName').textContent=d==='easy'?'Tiny Tim says:':d==='medium'?'Captain Leo says:':'Wizard Max says:';
  initGame();
}
function changeDiff(d){
  diff=d;
  document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('lb-'+d).classList.add('active');
  document.getElementById('leoFace').textContent=getDiffFace();
  document.getElementById('leoName').textContent=d==='easy'?'Tiny Tim says:':d==='medium'?'Captain Leo says:':'Wizard Max says:';
  leoSay(`Difficulty changed to ${d==='easy'?'Easy üê£':d==='medium'?'Medium ü¶Å':'Hard üßô'}! Starting a new game‚Ä¶`,'tip');
  setTimeout(initGame,800);
}
function newGame(){ 
  window.speechSynthesis?.cancel();
  document.getElementById('resultOverlay').classList.remove('show'); 
  initGame(); 
}
function initGame(){
  board=START.map(r=>[...r]); sel=null; turn='w'; previewMode=false; previewPiece=null;
  moveLog=[]; youCap=[]; leoCap=[]; leoThinking=false; lastFrom=null; lastTo=null; hintSquare=null;
  if(!document.getElementById('sq_0_0')) buildBoard(); else renderBoard();
  updateTurnIndicator(); updateMoveLog(); updateCapDisplay();
  document.getElementById('resultOverlay').classList.remove('show');
  document.getElementById('previewBanner').classList.remove('show');
  document.getElementById('previewBtn').textContent='üëÅ Think Ahead'; 
  document.getElementById('previewBtn').style.cssText='';
  const openings=['Welcome! I\'m your chess coach! ü¶Å Pick a White piece and I\'ll show you where it can safely move. Green = safe, Yellow = risky, Red = don\'t go there!',
    'Ready to play! Remember: in the opening, try to move your pawns to the CENTER first, then develop your knights and bishops! Good luck!',
    'Let\'s go! Think before every move: "Is my piece safe here? Can Leo take it?" The red glow means your piece is in danger!'];
  leoSay(openings[Math.floor(Math.random()*openings.length)],'tip');
}
</script>
</body>
</html>
